---
title: 'Learn about the Exchange UM Troubleshooting Tool: Exchange 2013 Help'
TOCTitle: Learn about the Exchange UM Troubleshooting Tool
ms:assetid: cc11bf5e-2c87-4495-b2ad-3e9a6bc81dbc
ms:mtpsurl: https://technet.microsoft.com/library/Gg584301(v=EXCHG.150)
ms:contentKeyID: 55129213
ms.reviewer:
manager: serdars
ms.author: dmaguire
author: msdmaguire
f1.keywords:
- NOCSH
mtps_version: v=EXCHG.150
---

# Learn about the Exchange UM Troubleshooting Tool

_**Applies to:** Exchange Server 2013, Exchange Server 2016_

The Microsoft Exchange 2010 Unified Messaging Troubleshooting Tool is an Exchange Management Shell cmdlet named **Test-ExchangeUMCallFlow**. You can use this tool to conduct a series of diagnostic tests for Unified Messaging (UM) in your organization. If any of the tests fail, the tool reports the reason for the failure and possible solutions to fix the problem. You can only use the UM Troubleshooting Tool on Exchange 2010 or later servers.

The UM Troubleshooting Tool can be used to test whether voice mail is functioning correctly in both on-premises and cross-premises deployments. You can use this tool in UM deployments that include Microsoft Office Communications Server 2007 R2 or Microsoft Lync Server 2010 or later, or in UM deployments that include VoIP gateways, IP Private Branch eXchanges (IP PBXs), or session border controllers (SBCs).

> [!NOTE]
> The UM Troubleshooting Tool is used for testing and troubleshooting. The <STRONG>Test-UMConnectivity</STRONG> cmdlet, on the other hand, should be used for monitoring. The <STRONG>Test-UMConnectivity</STRONG> cmdlet is used with System Center Operations Manager (SCOM) management packs that are used for monitoring Exchange 2010 UM servers or Exchange 2013 Client Access and Mailbox servers and the telephony components. The <STRONG>Test-UMConnectivity</STRONG> cmdlet performs local SIP tests and local logon tests to mailboxes, and can be run as an SCOM task.

To download the UM Troubleshooting Tool, see [Unified Messaging Troubleshooting Tool](https://www.microsoft.com/download/details.aspx?id=20839).

## Overview

The UM Troubleshooting Tool simplifies testing and troubleshooting in UM deployments. When the UM Troubleshooting Tool is run, it automatically generates a set of trace files that are stored in the C:\\Users\\%UserProfile%\\AppData\\Roaming\\Microsoft Exchange 2010 UM Troubleshooting folder. The following trace files are generated by the tool:

- **UMTool\_Collaboration**: Includes RTC stack traces.

- **UMTool\_DiagnosticLog**: Lists all the tests that are run and their results.

- **UMTool\_S4**: Includes the S4: signaling stack traces.

- **UMTool\_SIPMessageLogs**: Includes the full SIP traces for the test call that's made.

The UM Troubleshooting Tool connects directly to an on-premises session border controller (SBC), if one exists, or connects to an SBC in a datacenter and emulates an incoming call as if the call was coming from a PBX through a VoIP gateway or an IP PBX. The UM Troubleshooting tool can be used to diagnose:

- Incorrect settings in on-premises or cross-premises UM deployments in which Office Communications Server 2007 R2 or Microsoft Lync Server is deployed.

- Incorrect settings on on-premises or cross-premises telephony equipment that includes VoIP gateways and PBXs or IP PBXs.

- Issues with Domain Name System (DNS).

- Certificate issues when you're using SIP secured or Secured UM dial plans.

- Signaling and media issues for DTMF (also known as touchtone) and audio.

If the UM Troubleshooting Tool detects a failure in your configuration, the tool reports the reason for the error and the possible solutions for the issues that have been detected. The errors that can be reported when the UM Troubleshooting Tool is used in an on-premises deployment include the following:

- The maximum call limit has been reached.

- The user isn't enabled for Unified Messaging.

- The UM IP gateway, dial plan, or hunt group information can't be located.

- The security type doesn't match the UM dial plan.

- There are no worker processes available to process the call.

- The UM service or UM Call Router services are stopped.

- The Active Directory forest couldn't be located.

- No disk space is available.

- Invalid SIP headers were used in the request.

- A call was made to an Office Communications Server 2007 R2 server or Lync Server server.

- The UM IP gateway is disabled.

- The URI for the user who is being called isn't valid.

When the UM Troubleshooting Tool is used in a cross-premises deployment, the errors that can be reported include the following:

- The user isn't enabled for Unified Messaging.

- The UM IP gateway is disabled.

- The URI for the user is invalid.

- The security type doesn't match the UM dial plan.

- Invalid SIP headers were used in the request.

- The UM IP gateway, dial plan, or hunt group information can't be located.

The UM Troubleshooting Tool sends a sample .wav file for 15 seconds. After the audio file and RTP audio stream are sent and played back, the tool reports general audio quality metrics for diagnosing audio quality issues related to network connectivity, such as jitter and average packet loss. These reports include the media stream quality to and from a UM server and contain the following:

- Network Mean Opinion Score (NMOS)

- Codec

- Latency in milliseconds (ms)

- Jitter in milliseconds (ms)

- % of packet loss

- The NMOS classification and rating that will be used to determine the audio quality will be:

  - NMOS less than 2 = Poor

  - NMOS greater than 2 but less than 3 = Average

  - NMOS greater than 3 but less than 4 = Good

  - NMOS greater than 4 but less than 5 = Excellent

The UM Troubleshooting Tool supports testing UM dial plans that use Secured, SIP Secured, and Unsecured calls. If you choose Secured or SIP Secured, the thumbprint of the certificate that's used is checked to determine whether the certificate is expired and the type of certificate that's used for TLS (Transport Layer Security) communications. The certificate is used to correctly identify and ensure the identity of the remote computer. When Secured or SIP Secured mode is selected, the UM Troubleshooting Tool verifies whether the following are true:

- The local certificate was found in the local computer store.

- The certificate being used is trusted.

- The target name specified in the certificate is valid.

- The certificate has expired.

- The remote computer trusts the certificate.

- The certificate has been revoked.

- The certificate doesn't have the required enhanced key usage.

The UM Troubleshooting Tool can be run in either Gateway or SIPClient mode, depending on whether Office Communications Server 2007 R2 or Lync Server is deployed or whether VoIP gateways and PBXs or IP PBXs are used with Unified Messaging servers. When either Gateway or SIPClient mode is used, the UM Troubleshooting Tool supports making calls using the following formats. The format that's used depends on the URI type of the UM dial plan:

- Telephone extension: 425-555-1010

- E.164 phone numbers: +1 (425) 555-1010

- SIP addresses: tonysmith@contoso.com

When SIPClient mode is used, the UM Troubleshooting Tool makes a voice memo call. This is a call that doesn't ring a phone or a Unified Communications (UC) endpoint. Instead, it sends the call directly to voice mail. When the UM Troubleshooting Tool is run in SIPClient mode, it will determine:

- Which target user is being called.

- Whether the SIP call was established successfully.

- Whether the SIP call was accepted by an Exchange 2010 Unified Messaging server or Exchange 2013 Mailbox server.

- Whether the correct DTMF sequence was received.

- Whether the diagnostic .wav file was sent and received by an Exchange 2010 UM server or Exchange 2013 Mailbox server.

- The metrics that were used when the media or audio quality stream was received.

The UM Troubleshooting Tool emulates incoming calls and runs a series of diagnostic tests that help on-premises administrators and tenant administrators test call flow for call answering and identify configuration errors. Although the UM Troubleshooting Tool can be used in call answering scenarios, it can't be used to test the following types of calls:

- Outlook Voice Access calls, including calls that access voice mail, email, calendar, the directory, personal contacts, or personal options

- UM auto attendants

- Play on Phone

- Call Answering Rules

- Faxing

- Prompt provisioning

## UM troubleshooting architecture

The UM Troubleshooting Tool can help you troubleshoot, diagnose, and repair configuration issues in cross-premises deployments, and you can also use it in on-premises Unified Messaging deployments. In cross-premises deployments, the tool also validates onsite SBC configurations. The administrator can test all the Unified Messaging components that are used by Unified Messaging, including the SBCs.

## VoIP gateway and IP PBX deployments

In the following example, Gateway mode is used to test call flow in an environment that doesn't include Office Communications Server 2007 R2 or Lync Server. This example tests the telephony equipment, including VoIP gateways, PBXs and IP PBXs, and the Unified Messaging components. This example sets the Voice over IP (VoIP) security mode to Unsecured, uses the IP address 10.1.1.1 as the next hop, and includes an extension number in the diversion information.

```powershell
Test-ExchangeUMCallFlow -Mode Gateway -VoIPSecurity Unsecured -NextHop 10.1.1.1 -Diversion 12345
```

## Office Communications Server 2007 R2 and Microsoft Lync Server deployments

The UM Troubleshooting Tool can be used in on-premises or cross-premises deployments that include Office Communications Server 2007 R2 or Microsoft Lync Server when SIPClient mode is set. The following example uses SIPClient mode and tests the call flow with a secured UM dial plan in an environment that contains Office Communications Server 2007 R2 or Lync Server servers. By default, when you run the UM Troubleshooting Tool, it uses the credentials of the user who is currently logged on to the computer. When you run the following example, you'll be prompted for the credentials you want to use when you run the UM Troubleshooting Tool. For details, see [Set the credentials to use with the Exchange UM Troubleshooting Tool](set-the-credentials-to-use-with-the-exchange-um-troubleshooting-tool-exchange-2013-help.md).

```powershell
Test-ExchangeUMCallFlow -Mode SIPClient -VoIPSecurity Secured -CallingParty tony@contoso.com -CalledParty david@contoso.com -Credential $get
```

## Installing the UM Troubleshooting Tool

The UM Troubleshooting Tool can be installed on a local Unified Messaging server or on another 64-bit computer running either:

- The Windows 7 or Windows 8 operating systems.

- The Windows Server 2008 or Windows Server 2008 R2 operating systems.

- The Windows Server 2012 or Windows Server 2012 R2 operating systems.

If you're using the UM Troubleshooting Tool on a 64-bit version of Windows 7, Windows 8, or the 64-bit edition of Windows Server 2008, the following components must be installed before you can install the UM Troubleshooting Tool:

- Microsoft .NET Framework 3.5 Service Pack 1 (SP1)   See [Microsoft .NET Framework 3.5 Service Pack 1](https://www.microsoft.com/download/details.aspx?id=22).

    > [!NOTE]
    > If the tool will be run on a Windows Vista or Windows Server 2008 computer, see <A href="https://www.microsoft.com/download/details.aspx?id=1055">Microsoft .NET Framework 3.5 Family Update for Windows Vista x64, and Windows Server 2008 x64</A>.

- Windows Remote Management (WinRM) 2.0 and Windows PowerShell V2 (Windows6.0-KB968930.msu)   See Microsoft Knowledge Base article 968930, [Windows Management Framework Core package (Windows PowerShell 2.0 and WinRM 2.0)](https://support.microsoft.com/help/968930).

- Microsoft Unified Communications Managed API 2.0 Core Runtime (UcmaRuntimeWebDownloadX64.msi).

The UM Troubleshooting Tool (**Test-ExchangeUMCallFlow** cmdlet) isn't included on the Exchange 2010 SP1 DVD, the download that only includes Exchange 2010, or the Exchange 2013 installation media. However you can download the UM Troubleshooting Tool from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=20839).

For details, see [Install the Exchange UM Troubleshooting Tool](install-the-exchange-um-troubleshooting-tool-exchange-2013-help.md).

## Cmdlet parameters

The following table includes the parameters you can use with the **Test-ExchangeUMCallFlow** cmdlet and descriptions of those parameters. You can also use the Shell command `Get-help Test-ExchangeUMCallFlow -detailed` to find detailed information about each parameter that can be used with the **Test-ExchangeUMCallFlow** cmdlet, along with usage examples.

### Parameters

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>CalledParty</em></p></td>
<td><p>The <em>CalledParty</em> parameter specifies the SIP URI of the Office Communications Server 2007 R2 or Lync Server user who has been enabled for Enterprise Voice. This is the user who the <strong>Test-ExchangeUMCallFlow</strong> cmdlet will make the voice call to, for example: <code>-CalledParty tonysmith@contoso.com</code>. Use this parameter if you're running the tool in SIPClient mode.</p></td>
</tr>
<tr class="even">
<td><p><em>CallingParty</em></p></td>
<td><p>The <em>CallingParty</em> parameter specifies the SIP URI of the Office Communications Server 2007 R2 or Lync Server user who has been enabled for Enterprise Voice. This is the user who's making the incoming call, for example: <code>-CallingParty tonysmith@contoso.com</code>. Use this parameter if you're running the tool in SIPClient mode.</p></td>
</tr>
<tr class="odd">
<td><p><em>Diversion</em></p></td>
<td><p>The <em>Diversion</em> parameter specifies the string that should be sent as diversion information for the incoming call. This can be in the form of a Diversion or History-Info header. The diversion information that is included in the incoming call can be an extension number or can include additional diversion information.</p>
<p>When you provide diversion information as a History-Info header, verify the following:</p>
<ul>
<li><p>There are at least two different entries with different user parts.</p></li>
<li><p>The last entry contains the pilot number of the user's associated UM dial plan.</p></li>
<li><p>The second-to-last entry includes a UM-enabled user's extension number. This entry must also include the appropriate Reason text. This text must be escaped correctly in accordance with standard URL parameter escaping rules.</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><em>Mode</em></p></td>
<td><p>The <em>Mode</em> parameter specifies whether the VoIP gateway, IP PBX, or Office Communications Server 2007 R2 or Lync Server mode is to be used. You can specify either Gateway mode when your UM deployment includes VoIP gateways or IP PBXs or SIPClient mode when your UM deployment includes Office Communications Server 2007 R2 or Lync Server.</p></td>
</tr>
<tr class="odd">
<td><p><em>NextHop</em></p></td>
<td><p>The <em>NextHop</em> parameter specifies the IP address or fully qualified domain name (FQDN) of the next hop and can also include the TCP port of the next hop that the <strong>Test-ExchangeUMCallFlow</strong> cmdlet must connect to while emulating the VoIP gateway or IP PBX. When you include the TCP port, you must specify either port 5060 for Unsecured mode or port 5061 for Secured or SIP Secured mode. For example: <code>gateway.contoso.com:5061</code>.</p></td>
</tr>
<tr class="even">
<td><p><em>CertificateThumbprint</em></p></td>
<td><p>The <em>CertificateThumbprint</em> parameter specifies the thumbprint of the certificate used for TLS. This is required if either SIP Secured or Secured mode is configured on the UM dial plan. This certificate thumbprint is the certificate that was exported from the VoIP gateway, IP PBX, or SBC. Also, the computer that has the UM Troubleshooting Tool installed and is being used to test for call flow must trust the certificate of authority for the next hop.</p></td>
</tr>
<tr class="odd">
<td><p><em>Credential</em></p></td>
<td><p>The <em>Credential</em> parameter specifies the credentials that will be used to run the cmdlet.</p></td>
</tr>
<tr class="even">
<td><p><em>HuntGroup</em></p></td>
<td><p>The <em>HuntGroup</em> parameter specifies the UM hunt group associated with the VoIP gateway that's being emulated. This is typically an extension number. Use this parameter if you're running the tool in Gateway mode.</p></td>
</tr>
<tr class="odd">
<td><p><em>VoIPSecurity</em></p></td>
<td><p>The <em>VoIPSecurity</em> parameter specifies the security mode when using the cmdlet in Gateway mode. You can use one of the following VoIP security modes:</p>
<ul>
<li><p>Secured (TLS/SRTP)</p></li>
<li><p>Unsecured (TCP/RTP) (default)</p></li>
<li><p>SIP Secured (TLS/RTP)</p></li>
</ul></td>
</tr>
</tbody>
</table>
